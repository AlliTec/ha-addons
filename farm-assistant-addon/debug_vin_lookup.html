<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIN Lookup Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        select { margin: 5px; padding: 5px; width: 200px; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>VIN Lookup Debug Test</h1>
    
    <div class="debug-section info">
        <h3>Test VIN: 6FPAAAJG33333 (Ford Falcon XR6 Turbo Ute 2003)</h3>
        <p>This should populate: Make=Ford, Model=Falcon, Year=2003, Body Type=Ute, Badge=XR6 Turbo</p>
    </div>

    <div class="debug-section">
        <h3>Form Fields (as they appear in real app)</h3>
        <label>Make: </label>
        <select id="add-asset-make">
            <option value="">Select Make</option>
        </select>
        <br>
        <label>Model: </label>
        <select id="add-asset-model">
            <option value="">Select Model</option>
        </select>
        <br>
        <label>Year: </label>
        <select id="add-asset-year">
            <option value="">Select Year</option>
        </select>
        <br>
        <label>Body Type: </label>
        <select id="add-asset-body-feature">
            <option value="">Select Body Type</option>
        </select>
        <br>
        <label>Badge: </label>
        <select id="add-asset-badge">
            <option value="">Select Badge</option>
        </select>
        <br>
        <button onclick="testVINLookup()">Test VIN Lookup</button>
        <button onclick="resetForm()">Reset Form</button>
    </div>

    <div class="debug-section">
        <h3>Debug Log</h3>
        <div id="debug-log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logDiv.appendChild(entry);
            console.log(`[${timestamp}] ${message}`);
        }

        async function testVINLookup() {
            const vin = "6FPAAAJG33333";
            log(`üîç Starting VIN lookup for: ${vin}`, 'info');
            
            try {
                // Step 1: Lookup VIN specifications
                log('Step 1: Calling VIN specifications API...', 'info');
                const response = await fetch(`api/vin/specifications/${encodeURIComponent(vin)}`);
                
                if (!response.ok) {
                    log(`‚ùå VIN API failed: ${response.status} ${response.statusText}`, 'error');
                    return;
                }
                
                const specs = await response.json();
                log(`‚úÖ VIN API response received:`, 'success');
                log(`<pre>${JSON.stringify(specs, null, 2)}</pre>`, 'info');
                
                if (!specs.valid) {
                    log(`‚ùå VIN marked as invalid by API`, 'error');
                    return;
                }

                // Step 2: Populate form fields (mimic frontend logic)
                log('Step 2: Populating form fields...', 'info');
                
                const makeSelect = document.getElementById('add-asset-make');
                const modelSelect = document.getElementById('add-asset-model');
                const yearSelect = document.getElementById('add-asset-year');
                const bodySelect = document.getElementById('add-asset-body-feature');
                const badgeSelect = document.getElementById('add-asset-badge');
                
                // Set make
                if (specs.manufacturer && makeSelect) {
                    const makeName = specs.manufacturer.split(' ')[0];
                    log(`Looking for make: "${makeName}"`, 'info');
                    
                    // First populate makes
                    await populateMakes();
                    
                    const makeOption = Array.from(makeSelect.options).find(option => 
                        option.value.includes(makeName)
                    );
                    
                    if (makeOption) {
                        makeSelect.value = makeOption.value;
                        log(`‚úÖ Make set to: ${makeOption.value}`, 'success');
                        await populateVehicleModels(makeOption.value);
                        
                        // Set model
                        if (specs.model_info && specs.model_info.model && modelSelect) {
                            const modelOption = Array.from(modelSelect.options).find(option => 
                                option.value === specs.model_info.model
                            );
                            
                            if (modelOption) {
                                modelSelect.value = modelOption.value;
                                log(`‚úÖ Model set to: ${modelOption.value}`, 'success');
                                await populateVehicleYears(makeOption.value, modelOption.value);
                                
                                // Set year
                                if (specs.year && yearSelect) {
                                    const yearOption = Array.from(yearSelect.options).find(option => 
                                        option.value === specs.year.toString()
                                    );
                                    
                                    if (yearOption) {
                                        yearSelect.value = yearOption.value;
                                        log(`‚úÖ Year set to: ${yearOption.value}`, 'success');
                                        await populateVehicleBodyTypes(makeOption.value, modelOption.value, specs.year);
                                        
                                        // Set body type
                                        if (specs.model_info && specs.model_info.body_type && bodySelect) {
                                            const bodyOption = Array.from(bodySelect.options).find(option => 
                                                option.value === specs.model_info.body_type
                                            );
                                            
                                            if (bodyOption) {
                                                bodySelect.value = bodyOption.value;
                                                log(`‚úÖ Body type set to: ${bodyOption.value}`, 'success');
                                                await populateVehicleBadges(makeOption.value, modelOption.value, specs.year, specs.model_info.body_type);
                                                
                                                // Set badge
                                                if (specs.model_info && specs.model_info.trim && badgeSelect) {
                                                    const badgeOption = Array.from(badgeSelect.options).find(option => 
                                                        option.value === specs.model_info.trim
                                                    );
                                                    
                                                    if (badgeOption) {
                                                        badgeSelect.value = badgeOption.value;
                                                        log(`‚úÖ Badge set to: ${badgeOption.value}`, 'success');
                                                    } else {
                                                        log(`‚ùå Badge "${specs.model_info.trim}" not found in options`, 'error');
                                                        log(`Available badges: ${Array.from(badgeSelect.options).map(o => o.value).join(', ')}`, 'info');
                                                    }
                                                } else {
                                                    log(`‚ùå No trim info in VIN data`, 'error');
                                                }
                                            } else {
                                                log(`‚ùå Body type "${specs.model_info.body_type}" not found in options`, 'error');
                                                log(`Available body types: ${Array.from(bodySelect.options).map(o => o.value).join(', ')}`, 'info');
                                            }
                                        } else {
                                            log(`‚ùå No body_type info in VIN data`, 'error');
                                        }
                                    } else {
                                        log(`‚ùå Year "${specs.year}" not found in options`, 'error');
                                        log(`Available years: ${Array.from(yearSelect.options).map(o => o.value).join(', ')}`, 'info');
                                    }
                                } else {
                                    log(`‚ùå No year info in VIN data`, 'error');
                                }
                            } else {
                                log(`‚ùå Model "${specs.model_info.model}" not found in options`, 'error');
                                log(`Available models: ${Array.from(modelSelect.options).map(o => o.value).join(', ')}`, 'info');
                            }
                        } else {
                            log(`‚ùå No model info in VIN data`, 'error');
                        }
                    } else {
                        log(`‚ùå Make "${makeName}" not found in options`, 'error');
                        log(`Available makes: ${Array.from(makeSelect.options).map(o => o.value).join(', ')}`, 'info');
                    }
                } else {
                    log(`‚ùå No manufacturer info in VIN data`, 'error');
                }
                
                log('üéâ VIN lookup process completed!', 'success');
                
            } catch (error) {
                log(`‚ùå Error during VIN lookup: ${error.message}`, 'error');
                console.error('VIN lookup error:', error);
            }
        }

        async function populateMakes() {
            try {
                const response = await fetch('api/vehicle/makes');
                const makes = await response.json();
                
                const makeSelect = document.getElementById('add-asset-make');
                makeSelect.innerHTML = '<option value="">Select Make</option>';
                makes.forEach(make => {
                    makeSelect.innerHTML += `<option value="${make}">${make}</option>`;
                });
                
                log(`‚úÖ Populated ${makes.length} makes`, 'success');
            } catch (error) {
                log(`‚ùå Error populating makes: ${error.message}`, 'error');
            }
        }

        async function populateVehicleModels(make) {
            try {
                const response = await fetch(`api/vehicle/models?make=${encodeURIComponent(make)}`);
                const models = await response.json();
                
                const modelSelect = document.getElementById('add-asset-model');
                modelSelect.innerHTML = '<option value="">Select Model</option>';
                models.forEach(model => {
                    modelSelect.innerHTML += `<option value="${model}">${model}</option>`;
                });
                
                log(`‚úÖ Populated ${models.length} models for ${make}`, 'success');
            } catch (error) {
                log(`‚ùå Error populating models: ${error.message}`, 'error');
            }
        }

        async function populateVehicleYears(make, model) {
            try {
                const response = await fetch(`api/vehicle/years?make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}`);
                const years = await response.json();
                
                const yearSelect = document.getElementById('add-asset-year');
                yearSelect.innerHTML = '<option value="">Select Year</option>';
                years.forEach(year => {
                    yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                });
                
                log(`‚úÖ Populated ${years.length} years for ${make} ${model}`, 'success');
            } catch (error) {
                log(`‚ùå Error populating years: ${error.message}`, 'error');
            }
        }

        async function populateVehicleBodyTypes(make, model, year) {
            try {
                let url = `api/vehicle/body-types?make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}`;
                if (year) {
                    url += `&year=${year}`;
                }
                
                const response = await fetch(url);
                const bodyTypes = await response.json();
                
                const bodySelect = document.getElementById('add-asset-body-feature');
                bodySelect.innerHTML = '<option value="">Select Body Type</option>';
                bodyTypes.forEach(bodyType => {
                    bodySelect.innerHTML += `<option value="${bodyType}">${bodyType}</option>`;
                });
                
                log(`‚úÖ Populated ${bodyTypes.length} body types for ${make} ${model} ${year}`, 'success');
                log(`Available body types: ${bodyTypes.join(', ')}`, 'info');
            } catch (error) {
                log(`‚ùå Error populating body types: ${error.message}`, 'error');
            }
        }

        async function populateVehicleBadges(make, model, year, bodyType) {
            try {
                let url = `api/vehicle/badges?make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}`;
                if (year) url += `&year=${year}`;
                if (bodyType) url += `&body_type=${encodeURIComponent(bodyType)}`;
                
                const response = await fetch(url);
                const badges = await response.json();
                
                const badgeSelect = document.getElementById('add-asset-badge');
                badgeSelect.innerHTML = '<option value="">Select Badge</option>';
                badges.forEach(badge => {
                    badgeSelect.innerHTML += `<option value="${badge}">${badge}</option>`;
                });
                
                log(`‚úÖ Populated ${badges.length} badges for ${make} ${model} ${year} ${bodyType}`, 'success');
                log(`Available badges: ${badges.join(', ')}`, 'info');
            } catch (error) {
                log(`‚ùå Error populating badges: ${error.message}`, 'error');
            }
        }

        function resetForm() {
            ['add-asset-make', 'add-asset-model', 'add-asset-year', 'add-asset-body-feature', 'add-asset-badge'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('debug-log').innerHTML = '';
            log('Form reset. Ready for new test.', 'info');
        }

        // Initialize
        window.onload = function() {
            log('VIN Lookup Debug Tool loaded. Click "Test VIN Lookup" to begin.', 'info');
        };
    </script>
</body>
</html>